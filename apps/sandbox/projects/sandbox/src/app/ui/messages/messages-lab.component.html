<section class="panel" style="margin-bottom: 12px;">
    <div class="toolbar" style="justify-content: space-between; gap: 12px;">
        <div style="display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">
            <h1 style="margin:0; font-size: 18px;">Messages</h1>
            <span class="badge">Conversation: #{{ conversationId() }}</span>
            <span class="badge"
                  [class.badge--good]="status() === 'connected'"
                  [class.badge--warn]="status() === 'connecting'"
                  [class.badge--bad]="status() === 'closed'">
                SSE: {{ status() }}
            </span>
            @if (loading()) { <span class="badge">Loading…</span> }
        </div>
        <div class="toolbar">
            <form [formGroup]="searchForm">
                <input class="input" formControlName="q" placeholder="Search (id, text, IRI)" style="min-width: 260px;"/>
            </form>
            <button class="btn" type="button" (click)="routing()">Back</button>
            <button class="btn" type="button" (click)="load()">Reload</button>
            <button class="btn" type="button" (click)="watchAll()">SSE on</button>
            <button class="btn" type="button" (click)="unwatchAll()">SSE off</button>
        </div>
    </div>
    @if (error()) {
        <div class="badge badge--bad" style="margin-top: 10px;">{{ error() }}</div>
    }
</section>

<section class="panel" style="margin-bottom: 12px;">
    <form class="toolbar" style="gap: 10px; flex-wrap: wrap;" [formGroup]="createForm" (ngSubmit)="create()">
        <strong>Create (conversation #{{ conversationId() }})</strong>
        <input formControlName="originalText" placeholder="originalText" style="min-width: 320px;"/>
        <button class="btn btn--primary" type="submit" [disabled]="loading()">Create</button>
    </form>
</section>

<section class="layout">
    <!-- LISTE GAUCHE -->
    <div class="panel list">
        @if (filtered().length === 0) {
            <div class="muted" style="padding: 8px;">No messages.</div>
        }
        @for (m of filtered(); track m['@id']) {
            <div class="row"
                 [class.active]="m['@id'] === selectedId()"
                 (click)="select(m)">
                <div>
                    <div><strong>#{{ m['@id'] }}</strong></div>
                    <div style="font-size:12px;color:#6b7280">originalText: {{ m.originalText || '—' }}</div>
                </div>
            </div>
        }
    </div>

    <!-- DETAIL DROITE -->
    @if (selected(); as mesg) {
        <header class="toolbar" style="justify-content:space-between;">
            <div style="display:flex; gap:10px; align-items:center;">
                <h3 style="margin:0">Message #{{ mesg.id }}</h3>
                <span class="badge">IRI: <code>{{ mesg['@id'] }}</code></span>
            </div>
            <div class="toolbar">
                <button class="btn" type="button" (click)="watchOne()" [disabled]="!selectedId()">Watch</button>
                <button class="btn" type="button" (click)="unwatchOne()" [disabled]="!selectedId()">Unwatch</button>

                <button class="btn" type="button" (click)="manualGet()" [disabled]="!selectedId()">GET</button>
            </div>
        </header>

        <section style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top: 12px;">
            <div>
                <h4>Mise à jour (PATCH)</h4>
                <form style="display:grid; gap:8px;" [formGroup]="editForm" (ngSubmit)="patchOriginalText()">
                    <label>
                        <div style="font-size:12px;color:#6b7280">originalText</div>
                        <input formControlName="originalText" placeholder="nouvel originalText"/>
                    </label>
                    <button class="btn btn--primary" type="submit" [disabled]="!selectedId() || loading()">Save</button>
                </form>
            </div>

            <div>
                <h4>Meta</h4>
                <div class="badge">conversation: {{ mesg.conversation || '—' }}</div>
            </div>
        </section>

        <section style="margin-top: 16px;">
            <h4>Snapshot courant</h4>
            <app-json-viewer [value]="mesg" title="Message JSON"></app-json-viewer>
        </section>

        <section style="margin-top: 16px;">
            <h4>Event log</h4>
            <app-json-viewer [value]="logs()" title="Logs"></app-json-viewer>
        </section>
    } @else {
        <div class="panel">
            <h3 style="margin-top: 0;">Select a message</h3>
            <p class="muted">Create a message, reload the subresource list, then patch and test SSE watch/unwatch.</p>
        </div>
    }
</section>
